generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String             @id @default(cuid())
  email             String             @unique
  password          String
  role              String             @default("AGENT")
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  documentTemplates DocumentTemplate[]
  sales             Sale[]

  @@map("users")
}

model Sale {
  id                     String              @id @default(cuid())
  createdAt              DateTime            @default(now())
  updatedAt              DateTime            @updatedAt
  customerFirstName      String
  customerLastName       String
  title                  String?
  phoneNumber            String
  email                  String
  notes                  String?
  mailingStreet          String?
  mailingCity            String?
  mailingProvince        String?
  mailingPostalCode      String?
  accountName            String
  sortCode               String
  accountNumber          String
  directDebitDate        DateTime
  applianceCoverSelected Boolean             @default(false)
  boilerCoverSelected    Boolean             @default(false)
  boilerPriceSelected    Float?
  totalPlanCost          Float
  createdById            String
  agentName              String?
  appliances             Appliance[]
  generatedDocuments     GeneratedDocument[]
  createdBy              User                @relation(fields: [createdById], references: [id])
  smsLogs                SMSLog[]

  @@map("sales")
}

model Appliance {
  id         String  @id @default(cuid())
  saleId     String
  appliance  String
  otherText  String?
  coverLimit Float
  cost       Float
  sale       Sale    @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("appliances")
}

model FieldConfiguration {
  id         String   @id @default(cuid())
  fieldName  String   @unique
  isRequired Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("field_configurations")
}

model SMSLog {
  id                   String    @id @default(cuid())
  saleId               String
  phoneNumber          String
  normalizedPhone      String?
  messageContent       String
  smsStatus            SMSStatus @default(NOT_SENT)
  smsSentAt            DateTime?
  smsProviderMessageId String?
  smsError             String?
  smsExternalReference String    @unique
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  sale                 Sale      @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@index([saleId])
  @@index([smsStatus])
  @@map("sms_logs")
}

model DocumentTemplate {
  id                 String              @id @default(cuid())
  name               String
  description        String?
  templateType       String
  htmlContent        String
  isActive           Boolean             @default(true)
  version            Int                 @default(1)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  createdById        String
  createdBy          User                @relation(fields: [createdById], references: [id])
  generatedDocuments GeneratedDocument[]

  @@unique([templateType, version])
  @@index([templateType, isActive])
  @@map("document_templates")
}

model GeneratedDocument {
  id             String           @id @default(cuid())
  saleId         String
  templateId     String
  filename       String
  filePath       String
  fileSize       Int
  mimeType       String           @default("application/pdf")
  generatedAt    DateTime         @default(now())
  downloadCount  Int              @default(0)
  lastDownloadAt DateTime?
  isDeleted      Boolean          @default(false)
  metadata       Json?
  sale           Sale             @relation(fields: [saleId], references: [id], onDelete: Cascade)
  template       DocumentTemplate @relation(fields: [templateId], references: [id])

  @@index([saleId])
  @@index([templateId])
  @@index([generatedAt])
  @@map("generated_documents")
}

enum SMSStatus {
  NOT_SENT
  SENDING
  SENT
  FAILED
  SKIPPED
}
